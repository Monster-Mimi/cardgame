import random
import json
import os
import sys

SAVE_FILE = "card_game_save.json"

def create_player_cards():
	suits = ["Hearts","Spades","Dimonds","Clubs"]
	numbers = [1,2,3,4,5,6,7,8,9,10,"Jack","Queen","King","Ace"]
	cards = {}
	for suit in suits:
		for num in numbers:
			if num == "Jack":
				cards[f"{num} of {suit}"] = 11
				continue
			elif num == "Queen":
                        	cards[f"{num} of {suit}"] = 12
                        	continue
			elif num == "King":
                        	cards[f"{num} of {suit}"] = 13
                        	continue
			elif num == "Ace":
                        	cards[f"{num} of {suit}"] = 14
                        	continue
			cards[f"{num} of {suit}"] = num
	keys = list(cards.keys())
	random.shuffle(keys)
	split_index = int(len(keys) * 0.5)
	player1keys = keys[:split_index]
	player2keys = keys[split_index:]
	player1 = {k: cards[k] for k in player1keys}
	player2 = {k: cards[k] for k in player2keys}
	return player1, player2

def decide_winning_card(player1,player2):
	player1_card = list(player1.items())[0]
	player2_card = list(player2.items())[0]
	print(f"player1 card {player1_card[0]}")
	print(f"player2 card {player2_card[0]}")
	if player1_card[1] > player2_card[1]:
		print("player 1 wins!")
		del player2[player2_card[0]]
		player1[player2_card[0]] = player2_card[1]
		del player1[player1_card[0]]
		player1[player1_card[0]] = player1_card[1]
	elif player1_card[1] < player2_card[1]:
		print("player 2 wins!")
		del player1[player1_card[0]]
		player2[player1_card[0]] = player1_card[1]
		del player2[player2_card[0]]
		player2[player2_card[0]] = player2_card[1]
	elif player1_card[1] == player2_card[1]:
		print("its a draw!")
		del player2[player2_card[0]]
		player2[player2_card[0]] = player2_card[1]
		del player1[player1_card[0]]
		player1[player1_card[0]] = player1_card[1]
	return player1,player2

def save_game(player1_hand, player2_hand,player1money_hand, player2money_hand):
	game_state = {"player1": player1_hand,"player2": player2_hand,"player1money": player1money_hand, "player2money": player2money_hand}
                        player2[player2_card[0]] = player2_card[1]
                        del player1[player1_card[0]]
                        player2[player1_card[0]] = player1_card[1]
                        player1money = player1money - int(sys.argv[1])
                        player2money = player2money + int(sys.argv[1])
        if len(sys.argv) < 2 or sys.argv[1] == sys.argv[2]:
                player1, player2 = decide_winning_card(player1,player2)
        player1_card = list(player1.items())[0]
        player2_card = list(player2.items())[0]
        print("---player1 info---")
        print(f"next card {player1_card[0]}")
        print(f"total money {player1money}")
        print(f"card count {len(player1)}")
        print("---player2 info---")
        print(f"next card is {player2_card[0]}")
        print(f"total money {player2money}")
        print(f"card count {len(player2)}")
if len(player1) == 0:
        print("player 2 wins due to player 1 having no more cards!")
        if os.path.exists(SAVE_FILE):
                os.remove(SAVE_FILE)
if len(player2) == 0:
        print("player 1 wins due to player 2 having no more cards!")
        if os.path.exists(SAVE_FILE):
                os.remove(SAVE_FILE)
if player1money <= 0:
        print("player 2 wins due to player 1 going bust!")
        if os.path.exists(SAVE_FILE):
                os.remove(SAVE_FILE)
                print("done")
if player2money <= 0:
        print("player 1 wins due to player 1 going bust!")
        if os.path.exists(SAVE_FILE):
                os.remove(SAVE_FILE)
else:
        save_game(player1, player2, player1money, player2money)
if len(sys.argv) > 3:
        if sys.argv[3] == "r":
                if os.path.exists(SAVE_FILE):
                        os.remove(SAVE_FILE)
                        print("save file removed")
        elif sys.argv[3] == "--info":
                print(f"player 1s cards {player1}")
                print(f"player 2s cards {player2}")
        else:
                print("invalid statement")
	with open(SAVE_FILE, 'w') as f:
		json.dump(game_state, f, indent=4)
	print("Game state saved.")

def load_game():
	if os.path.exists(SAVE_FILE):
		try:
			with open(SAVE_FILE, 'r') as f:
				game_state = json.load(f)
				if not game_state["player1"] or not game_state["player2"]:
					print("Previous game was finished. Starting new game.")
					return None, None, None, None
				print("--- Saved game loaded! Resuming. ---")
				return game_state["player1"], game_state["player2"], game_state["player1money"], game_state["player2money"]
		except Exception as e:
			print(f"Save file found, but error loading: {e}. Starting new game.")
			return None, None, None, None
	else:
		print("--- No save file found. Starting new game. ---")
		return None, None, None, None
player1, player2, player1money, player2money = load_game()
if player1 is None or player2 is None:
	player1, player2 = create_player_cards()
	player1money = 1000
	player2money = 1000
	save_game(player1,player2,player1money,player2money)
	print("New game started! Run again to begin.")
else:
	if len(sys.argv) > 2:
		if int(sys.argv[1]) > player1money or int(sys.argv[2]) > player2money:
			print("No cheating!")
			sys.exit(1)
		if int(sys.argv[1]) > int(sys.argv[2]):
			print("player1 wins due to having the higher bet!")
			player1_card = list(player1.items())[0]
			player2_card = list(player2.items())[0]
			del player2[player2_card[0]]
			player1[player2_card[0]] = player2_card[1]
			del player1[player1_card[0]]
			player1[player1_card[0]] = player1_card[1]
			player1money = player1money + int(sys.argv[2])
			player2money = player2money - int(sys.argv[2])
		elif int(sys.argv[1]) < int(sys.argv[2]):
			print("player2 wins due to having the higher bet!")
			player1_card = list(player1.items())[0]
			player2_card = list(player2.items())[0]
			del player2[player2_card[0]]
			player2[player2_card[0]] = player2_card[1]
			del player1[player1_card[0]]
			player2[player1_card[0]] = player1_card[1]
			player1money = player1money - int(sys.argv[1])
			player2money = player2money + int(sys.argv[1])
	if len(sys.argv) < 2 or sys.argv[1] == sys.argv[2]:
		player1, player2 = decide_winning_card(player1,player2)
	player1_card = list(player1.items())[0]
	player2_card = list(player2.items())[0]
	print("---player1 info---")
	print(f"next card {player1_card[0]}")
	print(f"total money {player1money}")
	print(f"card count {len(player1)}")
	print("---player2 info---")
	print(f"next card is {player2_card[0]}")
	print(f"total money {player2money}")
	print(f"card count {len(player2)}")
if len(player1) == 0:
	print("player 2 wins due to player 1 having no more cards!")
	if os.path.exists(SAVE_FILE):
		os.remove(SAVE_FILE)
elif len(player2) == 0:
	print("player 1 wins due to player 2 having no more cards!")
	if os.path.exists(SAVE_FILE):
		os.remove(SAVE_FILE)
elif player1money <= 0:
	print("player 2 wins due to player 1 going bust!")
	if os.path.exists(SAVE_FILE):
		os.remove(SAVE_FILE)
elif player2money <= 0:
	print("player 1 wins due to player 1 going bust!")
	if os.path.exists(SAVE_FILE):
		os.remove(SAVE_FILE)
else:
	save_game(player1, player2, player1money, player2money)
if len(sys.argv) > 3:
	if sys.argv[3] == "r":
		if os.path.exists(SAVE_FILE):
			os.remove(SAVE_FILE)
			print("save file removed")
	elif sys.argv[3] == "--info":
		print(f"player 1s cards {player1}")
		print(f"player 2s cards {player2}")
	else:
		print("invalid statement")
